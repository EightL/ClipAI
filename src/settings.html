<!doctype html><html><head><meta charset="utf-8" />
<title>ClipAI Settings</title>
<style>
  :root{--bg:#ffffff;--fg:#1b2733;--panel:#f5f8fa;--panel-alt:#ffffff;--border:#d6dee4;--accent:#2563eb;--accent-fg:#fff;--field:#eef3f6;--field-border:#d3dde3;--danger:#ff4f5d;--radius:22px}
  body.dark{--bg:#101418;--fg:#f5f7fa;--panel:#182028;--panel-alt:#141b21;--border:#27323a;--accent:#4f9cff;--field:#1f2a33;--field-border:#33424c}
  body.midnight{--bg:#0b0f17;--fg:#e4ecf5;--panel:#121926;--panel-alt:#0e151f;--border:#1f2b3a;--accent:#5b8fff;--field:#182233;--field-border:#27354a}
  body.forest{--bg:#0f1613;--fg:#e2f5ec;--panel:#16231d;--panel-alt:#14211b;--border:#1f3328;--accent:#34c482;--field:#1b2d23;--field-border:#254233}
  body.rose{--bg:#1c1014;--fg:#fde8ef;--panel:#26171d;--panel-alt:#221318;--border:#3a222a;--accent:#ff4f8b;--field:#2d1c23;--field-border:#442832}
  body.amber{--bg:#191307;--fg:#fff3d6;--panel:#241c0d;--panel-alt:#20180c;--border:#3a2b14;--accent:#f4b21a;--field:#2b210f;--field-border:#423016}
  body.contrast{--bg:#000;--fg:#fff;--panel:#000;--panel-alt:#111;--border:#555;--accent:#ffdd33;--field:#0d0d0d;--field-border:#555}
    main, .preset-toolbar { background: var(--bg) !important; color: var(--fg) !important; }
  html,body{margin:0;padding:0;font:14px system-ui;background:var(--bg)!important;color:var(--fg)!important;height:100%;min-height:100vh;-webkit-font-smoothing:antialiased}
  main{padding:26px 32px 56px;max-width:1180px;margin:0 auto;display:flex;flex-direction:column;gap:28px}
  h1{font-size:22px;margin:0;font-weight:650;letter-spacing:.4px}
  h2{font-size:14px;margin:0 0 10px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;opacity:.7}
  button{font:600 13px system-ui;border-radius:10px;cursor:pointer;transition:.16s background,color,border,box-shadow;display:inline-flex;align-items:center;gap:6px;padding:8px 14px;background:var(--field);color:var(--fg);border:1px solid var(--field-border)}
  button:hover{background:var(--accent);color:var(--accent-fg);border-color:var(--accent);box-shadow:0 4px 18px -6px #0008}
  button:active{transform:translateY(1px)}
  .btn-icon{width:34px;justify-content:center;padding:8px}
  input,select,textarea{background:var(--field);color:var(--fg);border:1px solid var(--field-border);padding:10px 12px;border-radius:10px;font:13px system-ui;font-weight:500;width:100%;outline:none;transition:.16s border,box-shadow,background}
  textarea{min-height:84px;resize:vertical;line-height:1.35}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
  #presets-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:26px}
  .preset-card{background:var(--panel-alt);border:1px solid var(--border);border-radius:22px;padding:18px 18px 20px;display:flex;flex-direction:column;gap:14px;position:relative;box-shadow:0 6px 26px -14px #0008;transition:.18s border,background,box-shadow}
  .preset-card:hover{border-color:var(--accent);box-shadow:0 10px 34px -18px #000b}
  .preset-card-header{display:flex;align-items:center;gap:12px}
  .preset-name{flex:1;background:var(--field);border:1px solid var(--field-border);padding:10px 12px;font:600 13px system-ui;border-radius:12px;letter-spacing:.3px}
  .preset-name:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
  .preset-hotkey{white-space:nowrap}
  .preset-card-body{position:relative}
  .preset-prompt{width:100%;background:var(--field);border:1px solid var(--field-border);border-radius:14px;padding:12px 14px;font:500 13px system-ui;line-height:1.35;min-height:110px;resize:vertical;box-sizing:border-box}
  .preset-prompt:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
  .preset-card-footer{display:flex;justify-content:flex-end;align-items:center;margin-top:2px;gap:10px;font-size:11px}
  .preset-toolbar{position:static;background:var(--bg);padding:10px 4px 14px;display:flex;flex-wrap:wrap;align-items:center;gap:14px;border-bottom:1px solid var(--border);}
  .preset-toolbar-actions{display:flex;align-items:center;gap:8px;margin-left:auto}
  .hotkey-btn{background:var(--field);border:1px dashed var(--field-border);padding:10px 14px;font:600 12px system-ui;border-radius:10px;text-align:center;cursor:pointer;user-select:none;min-width:128px}
  .hotkey-btn.recording{background:var(--accent);color:var(--accent-fg);border-style:solid;border-color:var(--accent)}
  .delete-btn{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.15);border:0;color:#ff4f5d;width:32px;height:32px;border-radius:12px;font-size:16px;display:none;align-items:center;justify-content:center}
  .delete-mode .preset-card .delete-btn{display:flex}
  .delete-btn:hover{background:#ff4f5d;color:#fff}
  .segmented{display:flex;gap:6px;flex-wrap:wrap}
  .theme-btn,.memory-btn{background:var(--field);color:var(--fg);border:1px solid var(--field-border);padding:8px 14px;border-radius:8px;font:600 12px system-ui;cursor:pointer;transition:.15s background,color,border}
  .theme-btn.active,.memory-btn.active{background:var(--accent);color:var(--accent-fg);border-color:var(--accent)}
  .two-col{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:24px}
  .api-grid{gap:38px}
  .control-group{display:flex;flex-direction:column;gap:6px}
  .control-group>span{font-size:11px;font-weight:600;letter-spacing:.5px;opacity:.75;text-transform:uppercase}
  #status{font-size:12px;min-height:16px;font-weight:600;opacity:.75;margin-top:4px}
  .filter-box{display:flex;align-items:center;gap:10px;background:var(--panel);border:1px solid var(--border);padding:10px 14px;border-radius:14px;flex:1;box-shadow:0 4px 18px -12px #0005}
  .filter-box input{background:transparent;border:0;padding:0;font-size:13px;font-weight:500;width:100%}
  .filter-box input:focus{outline:none}
  .inline-pill{background:var(--field);border:1px solid var(--field-border);padding:4px 8px;border-radius:8px;font-size:11px;font-weight:600;opacity:.75}
  @media (max-width:760px){ main{padding:22px 18px 50px} .preset-toolbar{gap:10px} }
</style></head><body>
<main>
  <div class="preset-toolbar">
    <div style="display:flex;flex-direction:column;gap:2px;">
      <h1>Presets</h1>
      <div style="display:flex;align-items:center;gap:10px;font-size:12px;opacity:.65;">
        <span>Create, edit & assign hotkeys. First preset is default.</span>
        <span class="inline-pill" id="presetCountBadge">0</span>
      </div>
    </div>
    <div class="filter-box">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input id="presetFilter" placeholder="Filter presets…" aria-label="Filter presets" />
    </div>
    <div class="preset-toolbar-actions">
      <button class="btn-icon" id="addPresetBtn" title="Add preset" style="background:var(--accent);color:var(--accent-fg);border-color:var(--accent);">＋</button>
      <button class="btn-icon" id="toggleDeleteModeBtn" title="Toggle delete mode" style="color:var(--danger);border:1px solid var(--danger);">🗑</button>
    </div>
  </div>
  <div id="presets-grid"></div>
  <div style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:26px 28px 34px;display:flex;flex-direction:column;gap:34px;box-shadow:0 8px 32px -14px #0006;">
    <div>
      <h2>API Services</h2>
  <div class="two-col api-grid" style="align-items:end;">
        <div class="control-group"><span>Provider</span><select id="provider">
  <option value="openai">OpenAI</option>
  <option value="anthropic">Anthropic</option>
  <option value="gemini" selected>Gemini</option>
  <option value="groq">Groq</option>
  <option value="grok">Grok (OpenRouter)</option>
        </select></div>
        <div class="control-group"><span>API Key</span><input id="key" type="password" placeholder="..." autocomplete="off" /></div>
        <div class="control-group"><span>Model</span><select id="model"></select></div>
        <div class="control-group" style="min-width:140px;align-self:stretch;display:flex;flex-direction:column;justify-content:flex-end;">
          <button id="saveKey" style="background:var(--accent);color:var(--accent-fg);border-color:var(--accent);width:100%;justify-content:center;">Save</button>
        </div>
      </div>
      <div style="margin-top:8px;font-size:12px;opacity:.75">
        <strong>Tip:</strong> To save money, use cheaper models. We recommend <span style="font-weight:600">gemini-2.5-flash-lite</span> right now.
      </div>
      <div id="status"></div>
    </div>
    <div>
      <h2>Text Appearance</h2>
      <div class="two-col" style="align-items:start;">
        <div class="control-group"><span>Font Family</span><select id="fontFamily">
          <option value="system-ui">System UI</option>
          <option value="Georgia, Times, serif">Serif</option>
          <option value="Monaco, Consolas, monospace">Monospace</option>
          <option value="Inter, system-ui">Inter</option>
          <option value="SF Pro Display, system-ui">SF Pro Display</option>
          <option value="Helvetica Neue, system-ui">Helvetica Neue</option>
          <option value="Arial, sans-serif">Arial</option>
        </select></div>
        <div class="control-group"><span>Font Size</span>
          <div style="display:flex;align-items:center;gap:10px;">
            <input id="fontSizeRange" type="range" min="12" max="24" step="1" value="16" style="flex:1;accent-color:var(--accent);">
            <input id="fontSizeNumber" type="number" min="12" max="24" step="1" value="16" style="width:60px;text-align:right;font-weight:600;">
            <span style="font-size:11px;opacity:.7;">px</span>
          </div>
        </div>
        <div class="control-group"><span>Line Height</span>
          <div style="display:flex;align-items:center;gap:10px;">
            <input id="lineHeightRange" type="range" min="1.0" max="2.0" step="0.1" value="1.34" style="flex:1;accent-color:var(--accent);">
            <input id="lineHeightNumber" type="number" min="1.0" max="2.0" step="0.1" value="1.34" style="width:60px;text-align:right;font-weight:600;">
          </div>
        </div>
        <div class="control-group"><span>Letter Spacing</span>
          <div style="display:flex;align-items:center;gap:10px;">
            <input id="letterSpacingRange" type="range" min="-0.5" max="2.0" step="0.1" value="0" style="flex:1;accent-color:var(--accent);">
            <input id="letterSpacingNumber" type="number" min="-0.5" max="2.0" step="0.1" value="0" style="width:60px;text-align:right;font-weight:600;">
            <span style="font-size:11px;opacity:.7;">px</span>
          </div>
        </div>
      </div>
    </div>
    <div>
      <h2>Other</h2>
      <div class="two-col" style="align-items:start;">
        <div class="control-group"><span>Theme</span><div id="theme-buttons" class="segmented">
          <button class="theme-btn" data-theme="light">Light</button>
          <button class="theme-btn" data-theme="dark">Dark</button>
          <button class="theme-btn" data-theme="midnight">Midnight</button>
          <button class="theme-btn" data-theme="contrast">High Contrast</button>
        </div></div>
  <!-- Memory Mode removed -->
        <div class="control-group" style="min-width:200px;"><span>Auto Hide</span>
          <div style="display:flex;align-items:center;gap:10px;">
            <input type="checkbox" id="autoHideEnabled" style="width:18px;height:18px;" />
            <label for="autoHideEnabled" style="font-size:13px;user-select:none;">Enable Auto Hide</label>
            <input id="autoHideRange" type="range" min="5" max="30" step="1" value="10" list="autoHideTicks" style="flex:1;accent-color:var(--accent);margin-left:18px;">
            <input id="autoHideNumber" type="number" min="5" max="30" step="1" value="10" style="width:54px;text-align:right;font-weight:600;">
          </div>
          <datalist id="autoHideTicks"><option value="5"></option><option value="10"></option><option value="15"></option><option value="20"></option><option value="25"></option><option value="30"></option></datalist>
          <div style="display:flex;align-items:center;gap:8px;font-size:11px;margin-top:4px;">
            <span id="autoHideDescriptor" style="opacity:.75;font-weight:600;">Disabled (stays open)</span>
          </div>
        </div>
        <div class="control-group" style="min-width:160px;"><span>Markdown</span><select id="markdownMode">
          <option value="off">Off (plain text)</option>
          <option value="light">Light (bold & bullets)</option>
          <option value="full">Full</option>
        </select></div>
        <div class="control-group" style="min-width:200px;"><span>Auto Copy Selection</span>
          <div style="display:flex;align-items:center;gap:10px;">
            <input type="checkbox" id="autoCopyEnabled" style="width:18px;height:18px;" />
            <label for="autoCopyEnabled" style="font-size:13px;user-select:none;">Automatically press Ctrl/Cmd+C before summary</label>
          </div>
          <div style="font-size:11px;opacity:.7;margin-top:4px;">If disabled, you must copy manually before using the shortcut.</div>
        </div>
        <div class="control-group" style="min-width:200px;"><span>Unlimited Input - great for long document sessions</span>
          <div style="display:flex;align-items:center;gap:10px;">
            <input type="checkbox" id="unlimitedInputEnabled" style="width:18px;height:18px;" />
            <label for="unlimitedInputEnabled" style="font-size:13px;user-select:none;color:var(--warning);">⚠️ Use full model context window</label>
          </div>
          <div style="font-size:11px;opacity:.7;margin-top:4px;color:var(--warning);">Warning: May result in very high API costs. Extends the limit your model's context window.</div>
        </div>
        <div class="control-group" style="min-width:200px;">
          <span>Max Input Characters</span>
          <div style="display:flex;align-items:center;gap:12px;margin-top:8px;">
            <input type="range" id="maxInputCharsRange" min="1000" max="100000" step="1000" style="flex:1;" />
            <input type="number" id="maxInputCharsNumber" min="1000" max="100000" step="1000" style="width:80px;padding:4px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text);" />
          </div>
          <div style="font-size:11px;opacity:.7;margin-top:4px;">Character limit for input text (1,000 - 100,000). Higher values use more API tokens.</div>
        </div>
        <div class="control-group" style="min-width:200px;">
          <span>Max Output Tokens</span>
          <div style="display:flex;align-items:center;gap:12px;margin-top:8px;">
            <input type="range" id="maxOutputTokensRange" min="100" max="25000" step="100" style="flex:1;" />
            <input type="number" id="maxOutputTokensNumber" min="100" max="25000" step="100" style="width:80px;padding:4px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text);" />
          </div>
          <div style="font-size:11px;opacity:.7;margin-top:4px;">Maximum tokens for AI response (100 - 4,000). Higher values allow longer summaries but cost more.</div>
          <div style="font-size:11px;opacity:.7;margin-top:4px;">⚠️ Some models have their own limit</div>
        </div>
        
      </div>
    </div>
  </div>

  <!-- Document Sessions Section -->
  <div style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:20px;display:flex;flex-direction:column;gap:12px;box-shadow:0 8px 32px -14px #0006;">
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <h2 style="color:var(--accent);">📚 Document Sessions</h2>
      <button id="createSessionBtn" style="border:1px solid var(--accent);color:var(--accent);background:transparent;padding:6px 12px;border-radius:4px;font-size:12px;">+ New Session</button>
    </div>
    <div style="font-size:12px;opacity:.8;margin-bottom:8px;">Create context-aware sessions for books, papers, or research documents. All summaries within a session will include document context.</div>
    
    <!-- Active Session Display -->
    <div id="activeSessionDisplay" style="display:none;background:var(--bg);border:1px solid var(--accent);border-radius:4px;padding:12px;margin-bottom:8px;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-weight:600;color:var(--accent);font-size:13px;" id="activeSessionTitle">No active session</div>
          <div style="font-size:11px;opacity:.7;" id="activeSessionDetails">Click "New Session" to start</div>
        </div>
        <button id="endSessionBtn" style="border:1px solid var(--danger);color:var(--danger);background:transparent;padding:4px 8px;border-radius:3px;font-size:11px;">End Session</button>
      </div>
    </div>

    <!-- Sessions List -->
    <div id="sessionsList" style="display:flex;flex-direction:column;gap:8px;max-height:200px;overflow-y:auto;">
      <div style="text-align:center;opacity:.5;font-size:12px;padding:20px;">No saved sessions</div>
    </div>
  </div>

  <div style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:20px;display:flex;flex-direction:column;gap:12px;box-shadow:0 8px 32px -14px #0006;">
    <h2 style="color:var(--danger);">Reset Options</h2>
    <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:15px;">
      <div style="font-size:12px;opacity:.8;max-width:720px;">Reset preferences to defaults while keeping your presets and API keys.</div>
      <button id="resetPreferences" style="border:1px solid var(--accent);color:var(--accent);background:transparent;">Reset to Defaults</button>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;">
      <div style="font-size:12px;opacity:.8;max-width:720px;">This will remove all saved settings, providers, keys, presets, and restore defaults.</div>
      <button id="resetAll" style="border:1px solid var(--danger);color:var(--danger);background:transparent;">Reset All Settings</button>
    </div>
  </div>

    <div style="background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:20px;display:flex;flex-direction:column;align-items:center;gap:12px;box-shadow:0 8px 32px -14px #0006;margin-top:24px;">
      <h2 style="color:var(--accent);margin-bottom:8px;">Support Me :]</h2>
      <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;">
        <a href="https://buymeacoffee.com/eightl" target="_blank" rel="noopener" style="text-decoration:none;">
          <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me a Coffee" style="height:40px;border-radius:6px;box-shadow:0 2px 8px -4px #0003;" />
        </a>
      </div>
        <div style="margin-top:10px;width:100%;text-align:center;">
          <h2 style="color:var(--accent);font-size:15px;margin-bottom:6px;">Contact & Bugs</h2>
          <div style="font-size:13px;opacity:.8;">For bugs or feedback, reach me on Discord: <span style="font-weight:600;">8_L#8000</span></div>
          <div style="font-size:13px;opacity:.8;margin-top:4px;">Website: <a href="https://eightl.github.io/products" target="_blank" style="color:var(--accent);text-decoration:underline;">eightl.github.io</a></div>
        </div>
    </div>
</main>
<script>
  // Elements
  const providerSel = document.getElementById('provider');
  const keyInput = document.getElementById('key');
  const modelSelect = document.getElementById('model');
  const saveKeyBtn = document.getElementById('saveKey');
  const status = document.getElementById('status');
  const themeButtons = document.getElementById('theme-buttons');
  // memoryButtons removed
  const markdownModeSel = document.getElementById('markdownMode');
  const presetsGrid = document.getElementById('presets-grid');
  const addPresetBtn = document.getElementById('addPresetBtn');
  const toggleDeleteModeBtn = document.getElementById('toggleDeleteModeBtn');
  const autoHideEnabled = document.getElementById('autoHideEnabled');
  const autoHideRange = document.getElementById('autoHideRange');
  const autoHideNumber = document.getElementById('autoHideNumber');
  const autoHideDescriptor = document.getElementById('autoHideDescriptor');
  // Removed quick-toggle button (previously #autoHidePresets)
  const autoCopyEnabled = document.getElementById('autoCopyEnabled');
  const unlimitedInputEnabled = document.getElementById('unlimitedInputEnabled');
  const maxInputCharsRange = document.getElementById('maxInputCharsRange');
  const maxInputCharsNumber = document.getElementById('maxInputCharsNumber');
  const maxOutputTokensRange = document.getElementById('maxOutputTokensRange');
  const maxOutputTokensNumber = document.getElementById('maxOutputTokensNumber');
  const presetFilter = document.getElementById('presetFilter');
  const presetCountBadge = document.getElementById('presetCountBadge');
  const resetAllBtn = document.getElementById('resetAll');
  const resetPreferencesBtn = document.getElementById('resetPreferences');
  
  // Document Sessions controls
  const createSessionBtn = document.getElementById('createSessionBtn');
  const activeSessionDisplay = document.getElementById('activeSessionDisplay');
  const activeSessionTitle = document.getElementById('activeSessionTitle');
  const activeSessionDetails = document.getElementById('activeSessionDetails');
  const endSessionBtn = document.getElementById('endSessionBtn');
  const sessionsList = document.getElementById('sessionsList');
  
  // Text appearance controls
  const fontFamily = document.getElementById('fontFamily');
  const fontSizeRange = document.getElementById('fontSizeRange');
  const fontSizeNumber = document.getElementById('fontSizeNumber');
  const lineHeightRange = document.getElementById('lineHeightRange');
  const lineHeightNumber = document.getElementById('lineHeightNumber');
  const letterSpacingRange = document.getElementById('letterSpacingRange');
  const letterSpacingNumber = document.getElementById('letterSpacingNumber');

  // State
  let presets = [];
  let deleteMode = false;
  let recordingBtn = null;
  let filterText = '';
  let documentSessions = [];
  let activeSession = null;

  function formatCombo(e){
    let parts=[]; if(e.metaKey) parts.push('Command'); if(e.ctrlKey) parts.push('Control'); if(e.altKey) parts.push('Alt'); if(e.shiftKey) parts.push('Shift');
    
    let key = e.key;
    
    // Handle special keys
    if(key === ' ') key = 'Space';
    else if(key === 'Escape') key = 'Esc';
    else if(key.startsWith('Arrow')) key = key.replace('Arrow','');
    
    // Skip modifier-only combinations
    if(['Control','Shift','Alt','Meta','Command'].includes(key)) return '';
    
    // Filter out non-ASCII characters that can occur with Alt/Option combinations
    if (key.length === 1) {
      // Check if the character is ASCII (0-127)
      if (key.charCodeAt(0) > 127) {
        // Try to get the actual key from the code instead
        let actualKey = e.code;
        if (actualKey.startsWith('Key')) {
          key = actualKey.replace('Key', '');
        } else if (actualKey.startsWith('Digit')) {
          key = actualKey.replace('Digit', '');
        } else {
          // For other non-ASCII characters, skip this combination
          return '';
        }
      } else {
        key = key.toUpperCase();
      }
    }
    // Final validation - ensure all parts are ASCII
    const finalCombo = [...parts, key].join('+');
    if (!/^[\x00-\x7F]*$/.test(finalCombo)) {
      return ''; // Skip non-ASCII combinations
    }
    
    parts.push(key); 
    return parts.join('+');
  }

  function formatMouseCombo(e, button){
    let parts=[]; if(e.metaKey) parts.push('Command'); if(e.ctrlKey) parts.push('Control'); if(e.altKey) parts.push('Alt'); if(e.shiftKey) parts.push('Shift');
    switch(button) {
      case 0: parts.push('leftclick'); break;
      case 1: parts.push('middleclick'); break;
      case 2: parts.push('rightclick'); break;
      case 3: parts.push('mousebutton4'); break;
      case 4: parts.push('mousebutton5'); break;
      default: return '';
    }
    return parts.join('+');
  }

  async function formatShortcutWithIcons(shortcut, forDisplay = false){
    return await window.clipAI.formatShortcutWithIcons(shortcut, forDisplay);
  }
  document.addEventListener('keydown', async e=>{
    if(!recordingBtn) return; e.preventDefault(); e.stopPropagation();
    const presetId = recordingBtn.dataset.id; const preset = presets.find(p=>p.id===presetId); if(!preset) return;
    if(e.key==='Escape'){ recordingBtn.textContent = await formatShortcutWithIcons(preset.hotkey, true) || 'Set Key Sequence'; recordingBtn.classList.remove('recording'); recordingBtn=null; return; }
    if(e.key==='Backspace' || e.key==='Delete'){ preset.hotkey=''; recordingBtn.textContent='Set Key Sequence'; recordingBtn.classList.remove('recording'); recordingBtn=null; savePresets(); return; }
    const combo=formatCombo(e); 
    if(!combo) {
      // Show brief feedback for invalid combinations
      recordingBtn.textContent='Invalid combination';
      setTimeout(() => {
        recordingBtn.textContent='Press key/mouse combo…';
      }, 800);
      return; 
    }
    preset.hotkey=combo; recordingBtn.textContent=await formatShortcutWithIcons(combo, true); recordingBtn.classList.remove('recording'); recordingBtn=null; savePresets();
  });

  document.addEventListener('mousedown', async e=>{
    if(!recordingBtn) return; e.preventDefault(); e.stopPropagation();
    const presetId = recordingBtn.dataset.id; const preset = presets.find(p=>p.id===presetId); if(!preset) return;
    // Only handle mouse buttons 0-4 (left, middle, right, side buttons)
    if(e.button < 0 || e.button > 4) return;
    const combo=formatMouseCombo(e, e.button); if(!combo) return; preset.hotkey=combo; recordingBtn.textContent=await formatShortcutWithIcons(combo, true); recordingBtn.classList.remove('recording'); recordingBtn=null; savePresets();
  });

  function visiblePresets(){
    if(!filterText) return presets; const ft = filterText.toLowerCase(); return presets.filter(p=> (p.name||'').toLowerCase().includes(ft) || (p.prompt||'').toLowerCase().includes(ft));
  }
  function updatePresetCount(){ presetCountBadge.textContent = presets.length; }

  function renderPresets(){
    presetsGrid.innerHTML=''; presetsGrid.classList.toggle('delete-mode', deleteMode);
    const list = visiblePresets();
    if(list.length===0){
      const ph=document.createElement('div'); ph.textContent = presets.length===0 ? 'Click [+] to add your first preset.' : 'No presets match your filter.'; ph.style.cssText='text-align:center;opacity:.55;padding:28px 0;grid-column:1/-1;font-weight:500;'; presetsGrid.appendChild(ph);
    } else {
      list.forEach(p=> presetsGrid.appendChild(createPresetCard(p)) );
    }
    toggleDeleteModeBtn.classList.toggle('active', deleteMode);
    updatePresetCount();
  }
  function createPresetCard(preset){
    const card=document.createElement('div'); card.className='preset-card'; card.dataset.id=preset.id;
    // Header
    const header=document.createElement('div'); header.className='preset-card-header';
    const nameInput=document.createElement('input'); nameInput.type='text'; nameInput.className='preset-name'; nameInput.value=preset.name; nameInput.placeholder='Preset Name'; nameInput.onchange=e=>{ preset.name=e.target.value; savePresets(); };
    const hotkeyBtn=document.createElement('button'); hotkeyBtn.className='hotkey-btn preset-hotkey'; hotkeyBtn.dataset.id=preset.id; 
    // Set initial text content asynchronously
    formatShortcutWithIcons(preset.hotkey, true).then(text => hotkeyBtn.textContent = text || 'Set Key Sequence');
    hotkeyBtn.onclick=async ()=>{ if(recordingBtn){ const oldPreset = presets.find(p=>p.id===recordingBtn.dataset.id); recordingBtn.textContent= await formatShortcutWithIcons(oldPreset.hotkey, true) || 'Set Key Sequence'; recordingBtn.classList.remove('recording'); } recordingBtn=hotkeyBtn; hotkeyBtn.classList.add('recording'); hotkeyBtn.textContent='Press key/mouse combo…'; };
    header.appendChild(nameInput); header.appendChild(hotkeyBtn);
    // Body
    const body=document.createElement('div'); body.className='preset-card-body';
    const promptTextarea=document.createElement('textarea'); promptTextarea.className='preset-prompt'; promptTextarea.value=preset.prompt; promptTextarea.placeholder='Describe your own prompt here...'; promptTextarea.onchange=e=>{ preset.prompt=e.target.value; savePresets(); };
    body.appendChild(promptTextarea);
    // Footer (optional future actions)
    const footer=document.createElement('div'); footer.className='preset-card-footer';
    // Delete button overlays for delete mode
    const deleteBtn=document.createElement('button'); deleteBtn.className='delete-btn'; deleteBtn.textContent='✕'; deleteBtn.title='Delete preset'; deleteBtn.onclick=()=> removePreset(preset.id);
    card.appendChild(header); card.appendChild(body); card.appendChild(footer); card.appendChild(deleteBtn); return card;
  }
  function addPreset(){ presets.push({ id:`p_${Date.now()}`, name:`Preset ${presets.length+1}`, prompt:'Provide a concise summary.', hotkey:'' }); renderPresets(); savePresets(); }
  function removePreset(id){
    const preset = presets.find(p=>p.id===id);
    const name = preset?.name || 'this preset';
    if(!confirm(`Delete "${name}"? This cannot be undone.`)) return;
    presets = presets.filter(p=>p.id!==id);
    renderPresets();
    savePresets();
  }
  function toggleDeleteMode(){ deleteMode=!deleteMode; renderPresets(); }

  async function savePresets(){ const {conflicts}= await clipAI.setSummaryPresets({presets}); if(conflicts && conflicts.length){ status.textContent = `Warning: Duplicate hotkey "${conflicts[0].hotkey}"`; } else { status.textContent='Presets saved.'; } setTimeout(()=> status.textContent='', 2500); }

  addPresetBtn.onclick=addPreset; toggleDeleteModeBtn.onclick=toggleDeleteMode; presetFilter.addEventListener('input', e=>{ filterText=e.target.value.trim(); renderPresets(); });

  async function saveApiConfig(){ const key=keyInput.value.trim(); const model=modelSelect.value.trim(); if(!key){ status.textContent='API Key cannot be empty.'; return; } await clipAI.saveProviderKey(providerSel.value, key, model||undefined); await clipAI.setActiveProvider(providerSel.value); keyInput.type='password'; status.textContent='Saved successfully!'; setTimeout(()=> status.textContent='', 2000); }
  async function refreshModelsFor(provider){ const current=modelSelect.value; modelSelect.innerHTML=''; try { const models= await clipAI.listModels(provider); models.forEach(m=>{ const opt=document.createElement('option'); opt.value=m; opt.textContent=m; modelSelect.appendChild(opt); }); if(current && models.includes(current)) modelSelect.value=current; } catch(e){} }
  async function loadProviderConfig(provider){ const cfg= await clipAI.getConfig(); const pCfg=(cfg.providers && cfg.providers[provider])||{}; keyInput.type='text'; keyInput.value=pCfg.key||''; if(keyInput.value) keyInput.type='password'; const defaults={ openai:'gpt-5-mini', anthropic:'claude-3', gemini:'gemini-2.5-flash-lite', groq:'llama-3.1-70b-versatile', grok:'grok-4'}; const chosen=pCfg.model || defaults[provider] || ''; await refreshModelsFor(provider); if(chosen){ if(![...modelSelect.options].some(o=>o.value===chosen)){ const opt=document.createElement('option'); opt.value=chosen; opt.textContent=chosen; modelSelect.insertBefore(opt, modelSelect.firstChild);} modelSelect.value=chosen; } }

  async function updateTheme(theme){ ['light','dark','midnight','contrast'].forEach(t=> document.body.classList.remove(t)); document.body.classList.add(theme); themeButtons.querySelectorAll('.theme-btn').forEach(btn=> btn.classList.toggle('active', btn.dataset.theme===theme)); await clipAI.setTheme(theme); }
  // updateMemoryMode removed (memory feature removed)
  async function updateAutoHide(seconds, persist=true){
    autoHideRange.value = seconds;
    autoHideNumber.value = seconds;
    autoHideDescriptor.textContent = seconds === 0 ? 'Disabled (stays open)' : `Auto-hide after ${seconds}s`;
    if(persist){ await clipAI.setAutoHideMs(seconds * 1000); }
  }

  async function updateMaxInputChars(chars, persist=true){
    const validChars = Math.max(1000, Math.min(100000, parseInt(chars) || 25000));
    maxInputCharsRange.value = validChars;
    maxInputCharsNumber.value = validChars;
    if(persist){ await clipAI.setMaxInputChars(validChars); }
  }

  async function updateMaxOutputTokens(tokens, persist=true){
    const validTokens = Math.max(100, Math.min(25000, parseInt(tokens) || 800));
    maxOutputTokensRange.value = validTokens;
    maxOutputTokensNumber.value = validTokens;
    if(persist){ await clipAI.setMaxOutputTokens(validTokens); }
  }

  // Text appearance functions
  function updateFontSize(value, persist=true){
    const size = Math.min(24, Math.max(12, parseInt(value) || 16));
    fontSizeRange.value = size;
    fontSizeNumber.value = size;
    if(persist){ clipAI.setTextAppearance({fontSize: size}); }
  }

  function updateLineHeight(value, persist=true){
    const height = Math.min(2.0, Math.max(1.0, parseFloat(value) || 1.34));
    lineHeightRange.value = height;
    lineHeightNumber.value = height;
    if(persist){ clipAI.setTextAppearance({lineHeight: height}); }
  }

  function updateLetterSpacing(value, persist=true){
    const spacing = Math.min(2.0, Math.max(-0.5, parseFloat(value) || 0));
    letterSpacingRange.value = spacing;
    letterSpacingNumber.value = spacing;
    if(persist){ clipAI.setTextAppearance({letterSpacing: spacing}); }
  }

  function updateTextAppearance(settings, persist=true){
    if(settings.fontFamily !== undefined){
      fontFamily.value = settings.fontFamily;
    }
    if(settings.fontSize !== undefined){
      updateFontSize(settings.fontSize, false);
    }
    if(settings.lineHeight !== undefined){
      updateLineHeight(settings.lineHeight, false);
    }
    if(settings.letterSpacing !== undefined){
      updateLetterSpacing(settings.letterSpacing, false);
    }
    
    if(persist){
      clipAI.setTextAppearance(settings);
    }
  }

  saveKeyBtn.onclick=saveApiConfig; keyInput.addEventListener('focus',()=> keyInput.type='text'); keyInput.addEventListener('blur',()=>{ if(keyInput.value) keyInput.type='password'; });
  themeButtons.addEventListener('click', e=>{ if(e.target.classList.contains('theme-btn')) updateTheme(e.target.dataset.theme); });
  // memory mode listener removed
  autoHideEnabled.addEventListener('change', async ()=> { 
    if(autoHideEnabled.checked){ 
      await clipAI.setAutoHideMs(autoHideRange.value * 1000); 
    } else { 
      await clipAI.setAutoHideMs(0); 
    } 
  });
  autoHideRange.addEventListener('input', ()=> updateAutoHide(autoHideRange.value));
  autoHideNumber.addEventListener('input', ()=> updateAutoHide(autoHideNumber.value));
  markdownModeSel.addEventListener('change', async ()=> await clipAI.setMarkdownMode(markdownModeSel.value));
  autoCopyEnabled.addEventListener('change', async ()=> await clipAI.setAutoCopySelection(autoCopyEnabled.checked));
  themeButtons.addEventListener('click', e=> { if(e.target.classList.contains('theme-btn')){ updateTheme(e.target.dataset.theme); } });
  
  // Text appearance event listeners
  fontFamily.addEventListener('change', async ()=> await updateTextAppearance({fontFamily: fontFamily.value}));
  fontSizeRange.addEventListener('input', ()=> updateFontSize(fontSizeRange.value));
  fontSizeNumber.addEventListener('input', ()=> updateFontSize(fontSizeNumber.value));
  lineHeightRange.addEventListener('input', ()=> updateLineHeight(lineHeightRange.value));
  lineHeightNumber.addEventListener('input', ()=> updateLineHeight(lineHeightNumber.value));
  letterSpacingRange.addEventListener('input', ()=> updateLetterSpacing(letterSpacingRange.value));
  letterSpacingNumber.addEventListener('input', ()=> updateLetterSpacing(letterSpacingNumber.value));
  resetPreferencesBtn?.addEventListener('click', async ()=>{
    if(!confirm('Reset preferences to defaults? This will keep your presets and API keys but reset theme, auto-hide, text appearance, and other settings.')) return;
    try {
      await clipAI.resetPreferences();
      // Reload the UI to reflect defaults
      location.reload();
    } catch(e){}
  });

  resetAllBtn?.addEventListener('click', async ()=>{
    if(!confirm('Reset all settings to defaults? This cannot be undone.')) return;
    try {
      await clipAI.resetConfig();
      // Reload the UI to reflect defaults
      location.reload();
    } catch(e){}
  });

  // Document Sessions Functions
  function showSessionModal(editSession = null) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
    
    const form = document.createElement('div');
    form.style.cssText = 'background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:24px;width:400px;max-width:90vw;';
    
    form.innerHTML = `
      <h3 style="margin:0 0 16px 0;color:var(--accent);">${editSession ? 'Edit Session' : 'Create New Session'}</h3>
      <div style="margin-bottom:12px;">
        <label style="display:block;font-size:12px;margin-bottom:4px;opacity:0.8;">Document Title</label>
        <input type="text" id="sessionTitle" placeholder="e.g., The Lean Startup" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text);" value="${editSession?.title || ''}">
      </div>
      <div style="margin-bottom:12px;">
        <label style="display:block;font-size:12px;margin-bottom:4px;opacity:0.8;">Author(s)</label>
        <input type="text" id="sessionAuthor" placeholder="e.g., Eric Ries" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text);" value="${editSession?.author || ''}">
      </div>
      <div style="margin-bottom:12px;">
        <label style="display:block;font-size:12px;margin-bottom:4px;opacity:0.8;">Document Type</label>
        <select id="sessionType" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text);">
          <option value="book" ${editSession?.type === 'book' ? 'selected' : ''}>📚 Book</option>
          <option value="paper" ${editSession?.type === 'paper' ? 'selected' : ''}>📄 Academic Paper</option>
          <option value="thesis" ${editSession?.type === 'thesis' ? 'selected' : ''}>🎓 Thesis/Dissertation</option>
          <option value="report" ${editSession?.type === 'report' ? 'selected' : ''}>📊 Research Report</option>
          <option value="article" ${editSession?.type === 'article' ? 'selected' : ''}>📰 Article</option>
        </select>
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block;font-size:12px;margin-bottom:4px;opacity:0.8;">Context Notes (Optional)</label>
        <textarea id="sessionNotes" placeholder="Brief description of the work, key themes, or your research focus..." style="width:100%;height:60px;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text);resize:vertical;">${editSession?.notes || ''}</textarea>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button id="cancelSession" style="padding:8px 16px;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:4px;">Cancel</button>
        <button id="saveSession" style="padding:8px 16px;border:1px solid var(--accent);background:var(--accent);color:white;border-radius:4px;">${editSession ? 'Update' : 'Create'} Session</button>
      </div>
    `;
    
    modal.appendChild(form);
    document.body.appendChild(modal);
    
    document.getElementById('sessionTitle').focus();
    
    document.getElementById('cancelSession').onclick = () => document.body.removeChild(modal);
    modal.onclick = (e) => { if (e.target === modal) document.body.removeChild(modal); };
    
    document.getElementById('saveSession').onclick = () => {
      const title = document.getElementById('sessionTitle').value.trim();
      const author = document.getElementById('sessionAuthor').value.trim();
      const type = document.getElementById('sessionType').value;
      const notes = document.getElementById('sessionNotes').value.trim();
      
      if (!title) {
        alert('Please enter a document title');
        return;
      }
      
      const session = {
        id: editSession?.id || 'session_' + Date.now(),
        title,
        author,
        type,
        notes,
        created: editSession?.created || new Date().toISOString(),
        updated: new Date().toISOString()
      };
      
      if (editSession) {
        const index = documentSessions.findIndex(s => s.id === editSession.id);
        if (index !== -1) documentSessions[index] = session;
      } else {
        documentSessions.push(session);
      }
      
      saveDocumentSessions();
      renderSessions();
      document.body.removeChild(modal);
    };
  }

  async function activateSession(session) {
    activeSession = session;
    await clipAI.setActiveDocumentSession(session);
    updateActiveSessionDisplay();
    renderSessions(); // Re-render to update ACTIVE status immediately
  }

  async function endCurrentSession() {
    activeSession = null;
    await clipAI.setActiveDocumentSession(null);
    updateActiveSessionDisplay();
    renderSessions(); // Re-render to update ACTIVE status immediately
  }

  function deleteSession(sessionId) {
    if (!confirm('Delete this session? This cannot be undone.')) return;
    documentSessions = documentSessions.filter(s => s.id !== sessionId);
    if (activeSession?.id === sessionId) endCurrentSession();
    saveDocumentSessions();
    renderSessions();
  }

  function updateActiveSessionDisplay() {
    if (activeSession) {
      activeSessionDisplay.style.display = 'block';
      activeSessionTitle.textContent = activeSession.title;
      const typeEmoji = { book: '📚', paper: '📄', thesis: '🎓', report: '📊', article: '📰' }[activeSession.type] || '📄';
      activeSessionDetails.textContent = `${typeEmoji} ${activeSession.type} ${activeSession.author ? 'by ' + activeSession.author : ''}`;
    } else {
      activeSessionDisplay.style.display = 'none';
    }
  }

  function renderSessions() {
    if (documentSessions.length === 0) {
      sessionsList.innerHTML = '<div style="text-align:center;opacity:.5;font-size:12px;padding:20px;">No saved sessions</div>';
      return;
    }
    
    sessionsList.innerHTML = documentSessions.map(session => {
      const typeEmoji = { book: '📚', paper: '📄', thesis: '🎓', report: '📊', article: '📰' }[session.type] || '📄';
      const isActive = activeSession?.id === session.id;
      
      return `
        <div style="border:1px solid ${isActive ? 'var(--accent)' : 'var(--border)'};border-radius:4px;padding:12px;background:${isActive ? 'rgba(var(--accent-rgb), 0.1)' : 'var(--bg)'};position:relative;">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <div style="flex:1;">
              <div style="font-weight:600;font-size:13px;color:${isActive ? 'var(--accent)' : 'var(--text)'};">${typeEmoji} ${session.title}</div>
              <div style="font-size:11px;opacity:.7;margin-top:2px;">${session.author ? 'by ' + session.author : session.type}</div>
              ${session.notes ? `<div style="font-size:11px;opacity:.6;margin-top:4px;">${session.notes.slice(0, 80)}${session.notes.length > 80 ? '...' : ''}</div>` : ''}
            </div>
            <div style="display:flex;gap:8px;margin-left:12px;align-items:center;">
              ${!isActive ? `<button data-action="activate" data-session-id="${session.id}" style="padding:4px 8px;border:1px solid var(--accent);color:var(--accent);background:transparent;border-radius:6px;font-size:11px;">Activate</button>` : '<span style="display:inline-flex;align-items:center;gap:6px;padding:2px 10px;border:1px solid var(--accent);background:rgba(var(--accent-rgb),0.08);color:var(--accent);border-radius:999px;font-size:10px;font-weight:700;letter-spacing:.4px;text-transform:uppercase;">● Active</span>'}
              <button data-action="edit" data-session-id="${session.id}" style="padding:4px 6px;border:1px solid var(--border);color:var(--text);background:transparent;border-radius:3px;font-size:11px;">✏️</button>
              <button data-action="delete" data-session-id="${session.id}" style="padding:4px 6px;border:1px solid var(--danger);color:var(--danger);background:transparent;border-radius:3px;font-size:11px;">🗑️</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // Add event delegation for session buttons
  document.addEventListener('click', async (e) => {
    if (e.target.dataset.action) {
      const sessionId = e.target.dataset.sessionId || e.target.getAttribute('data-session-id');
      const session = documentSessions.find(s => s.id === sessionId);
      
      switch (e.target.dataset.action) {
        case 'activate':
          if (session) await activateSession(session);
          break;
        case 'edit':
          if (session) showSessionModal(session);
          break;
        case 'delete':
          if (sessionId) deleteSession(sessionId);
          break;
      }
    }
  });

  async function saveDocumentSessions() {
    try {
      await clipAI.setDocumentSessions(documentSessions);
    } catch(e) {
      console.error('Failed to save document sessions:', e);
    }
  }

  async function loadDocumentSessions() {
    try {
      const result = await clipAI.getDocumentSessions();
      documentSessions = result.sessions || [];
      activeSession = result.activeSession || null;
      renderSessions();
      updateActiveSessionDisplay();
    } catch(e) {
      console.error('Failed to load document sessions:', e);
    }
  }

  // Event listeners for sessions
  createSessionBtn.addEventListener('click', () => showSessionModal());
  endSessionBtn.addEventListener('click', endCurrentSession);

  async function init(){
    const cfg= await clipAI.getConfig();
    providerSel.value=cfg.active;
    await loadProviderConfig(cfg.active);
    updateTheme(cfg.theme||'light');
    const enabled = !!cfg.autoHideMs;
    autoHideEnabled.checked = enabled;
    let seconds = enabled ? Math.max(5, Math.min(30, Math.round(cfg.autoHideMs/1000))) : 10;
    updateAutoHide(seconds, false);
    markdownModeSel.value = cfg.markdownMode || (cfg.markdownEnabled===false ? 'off':'full');
  autoCopyEnabled.checked = cfg.autoCopySelection !== false; // default true
  unlimitedInputEnabled.checked = cfg.unlimitedInput || false;
  updateMaxInputChars(cfg.maxInputChars || 25000, false);
  updateMaxOutputTokens(cfg.maxOutputTokens || 800, false);
  
  unlimitedInputEnabled.addEventListener('change', async ()=> {
    if (unlimitedInputEnabled.checked) {
      const confirmed = confirm(`⚠️ UNLIMITED INPUT WARNING ⚠️

This will allow input up to your model's full context window (potentially 100k+ characters).

RISKS:
• Very high API costs
• Slower processing times
• May hit rate limits

Are you sure you want to enable unlimited input?`);
      
      if (!confirmed) {
        unlimitedInputEnabled.checked = false;
        return;
      }
    }
    
    await clipAI.setUnlimitedInput(unlimitedInputEnabled.checked);
  });

  // Max input chars event listeners
  maxInputCharsRange.addEventListener('input', ()=> updateMaxInputChars(maxInputCharsRange.value));
  maxInputCharsNumber.addEventListener('input', ()=> updateMaxInputChars(maxInputCharsNumber.value));
  
  // Max output tokens event listeners
  maxOutputTokensRange.addEventListener('input', ()=> updateMaxOutputTokens(maxOutputTokensRange.value));
  maxOutputTokensNumber.addEventListener('input', ()=> updateMaxOutputTokens(maxOutputTokensNumber.value));
    
    // Load text appearance settings
    const textAppearance = cfg.textAppearance || {};
    updateTextAppearance({
      fontFamily: textAppearance.fontFamily || 'system-ui',
      fontSize: textAppearance.fontSize || 16,
      lineHeight: textAppearance.lineHeight || 1.34,
      letterSpacing: textAppearance.letterSpacing || 0
    }, false);
    
    const presetData = await clipAI.getSummaryPresets();
    presets=(presetData.presets||[]).map(p=>({...p}));
    renderPresets();
    
    // Load document sessions
    await loadDocumentSessions();
  }
  clipAI.onThemeChanged?.(theme=> updateTheme(theme));
  init();
</script>
</body></html>
