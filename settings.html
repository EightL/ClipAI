<!doctype html><html><head><meta charset="utf-8" />
<title>ClipAI Settings</title>
<style>
  :root{--bg:#101418;--fg:#f5f7fa;--panel:#182028;--border:#27323a;--accent:#4f9cff;--accent-fg:#fff;--field:#1f2a33;--field-border:#33424c}
  body.light{--bg:#ffffff;--fg:#1b2733;--panel:#f5f8fa;--border:#d6dee4;--accent:#2563eb;--accent-fg:#fff;--field:#eef3f6;--field-border:#d3dde3}
  body.midnight{--bg:#0b0f17;--fg:#e4ecf5;--panel:#121926;--border:#1f2b3a;--accent:#5b8fff;--accent-fg:#ffffff;--field:#182233;--field-border:#27354a}
  body.forest{--bg:#0f1613;--fg:#e2f5ec;--panel:#16231d;--border:#1f3328;--accent:#34c482;--accent-fg:#042716;--field:#1b2d23;--field-border:#254233}
  body.rose{--bg:#1c1014;--fg:#fde8ef;--panel:#26171d;--border:#3a222a;--accent:#ff4f8b;--accent-fg:#2b0915;--field:#2d1c23;--field-border:#442832}
  body.amber{--bg:#191307;--fg:#fff3d6;--panel:#241c0d;--border:#3a2b14;--accent:#f4b21a;--accent-fg:#2a1900;--field:#2b210f;--field-border:#423016}
  body.contrast{--bg:#000000;--fg:#ffffff;--panel:#000000;--border:#555;--accent:#ffdd33;--accent-fg:#000;--field:#0d0d0d;--field-border:#555}
  html,body{margin:0;padding:0;font:14px system-ui;background:var(--bg);color:var(--fg);}
  h1{font-size:17px;margin:0 0 12px;font-weight:600}
  main{padding:18px 20px 28px;max-width:440px}
  label{display:flex;flex-direction:column;gap:4px;margin-bottom:14px;font-size:12px;font-weight:600;letter-spacing:.3px;text-transform:uppercase;opacity:.8}
  input,select{background:var(--field);color:var(--fg);border:1px solid var(--field-border);padding:8px 10px;border-radius:8px;font:13px system-ui;font-weight:500;outline:none;width:100%;box-sizing:border-box}
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
  button{background:var(--accent);color:var(--accent-fg);font:600 13px system-ui;border:1px solid var(--accent);padding:8px 14px;border-radius:8px;cursor:pointer;transition:.18s background, box-shadow}
  button:hover{box-shadow:0 2px 6px -2px #000a}
  button:active{box-shadow:0 0 0 2px var(--panel) inset}
  .row{display:flex;gap:12px}
  .grow{flex:1}
  small{font-size:11px;opacity:.55;display:block;margin-top:2px;line-height:1.4}
  #hotkeyBtns button{background:var(--field);color:var(--fg);border:1px dashed var(--field-border);font-weight:500;padding:6px 10px}
  #hotkeyBtns button.active{border-style:solid;background:var(--accent);color:var(--accent-fg)}
  #status{font-size:12px;margin-top:6px;font-weight:500}
  .sectionTitle{margin:22px 0 10px;font-size:13px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;opacity:.7}
</style></head><body>
<main>
  <div style="position:absolute;top:6px;left:6px;z-index:20;-webkit-app-region:no-drag">
    <button id="tinyClose" title="Close" style="background:rgba(255,255,255,0.08);border:1px solid var(--border);width:28px;height:26px;padding:0;font-size:14px;line-height:1;border-radius:8px;display:inline-flex;align-items:center;justify-content:center">✕</button>
  </div>
  <h1>ClipAI Settings</h1>
  <div class="sectionTitle">API Provider</div>
  <label>Provider
    <select id="provider">
      <option value="openai">OpenAI</option>
      <option value="gemini">Gemini</option>
  <option value="anthropic">Anthropic</option>
  <option value="mistral">Mistral</option>
  <option value="groq">Groq</option>
  <option value="cohere">Cohere</option>
    </select>
  </label>
  <label>API Key
    <input id="key" type="password" placeholder="sk-..." />
    <small>Stored locally in userData/config.json</small>
  </label>
  <label id="modelWrap" style="display:none">Model
    <div style="display:flex;gap:6px;align-items:center">
      <input id="model" placeholder="auto / custom" style="flex:1" />
      <button type="button" id="refreshModels" style="flex:0 0 auto;padding:6px 10px">Fetch</button>
    </div>
    <small id="modelHint">Enter custom model or fetch list.</small>
    <select id="modelList" size="5" style="margin-top:6px;display:none;width:100%;background:var(--field);color:var(--fg);border:1px solid var(--field-border);border-radius:8px;padding:4px 6px;font:12px system-ui"></select>
  </label>
  <div style="display:flex;gap:10px;align-items:center;margin-top:-4px;margin-bottom:4px">
    <button id="saveKey" style="flex:0 0 auto">Save</button>
    <div id="status"></div>
  </div>
  <div class="sectionTitle">Theme & Memory</div>
  <label class="row">Theme
    <select id="theme" class="grow">
      <option value="dark">Dark</option>
      <option value="light">Light</option>
      <option value="midnight">Midnight</option>
      <option value="forest">Forest</option>
      <option value="rose">Rose</option>
      <option value="amber">Amber</option>
      <option value="contrast">High Contrast</option>
    </select>
  </label>
  <label class="row">Memory Mode
    <select id="memory" class="grow">
      <option value="normal">Normal</option>
      <option value="aggressive">Aggressive (destroy window)</option>
    </select>
  </label>
  <label style="flex-direction:row;align-items:center;gap:8px">
    <input type="checkbox" id="markdownToggle" style="width:auto;flex:0 0 auto" />
    <span style="font-size:12px;font-weight:600;letter-spacing:.3px;text-transform:uppercase;opacity:.8">Markdown Rendering</span>
  </label>
  <div class="sectionTitle">Hotkeys</div>
  <div id="hotkeyBtns" style="display:flex;flex-direction:column;gap:10px">
    <div style="display:flex;align-items:center;gap:10px">
      <span style="width:80px;font-size:12px;opacity:.7">Summarize</span>
      <button id="hkSumm" class="grow" data-value="">Record…</button>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      <span style="width:80px;font-size:12px;opacity:.7">Explain</span>
      <button id="hkExplain" class="grow" data-value="">Record…</button>
    </div>
    <small>Press desired combo. Esc to cancel, Backspace to clear. Must include a non-modifier key.</small>
  </div>
  <div class="sectionTitle">Danger Zone</div>
  <button id="close" style="background:#444;border-color:#444">Close</button>
</main>
<script>
  // Settings window logic
  // Handles provider credentials, model lists, theme selection, hotkeys, and prompt preset customization.
  const providerSel = document.getElementById('provider');
  const keyInput = document.getElementById('key');
  const modelInput = document.getElementById('model');
  const modelWrap = document.getElementById('modelWrap');
  const saveKeyBtn = document.getElementById('saveKey');
  const status = document.getElementById('status');
  const themeSel = document.getElementById('theme');
  const memorySel = document.getElementById('memory');
  const markdownToggle = document.getElementById('markdownToggle');
  const hkSumm = document.getElementById('hkSumm');
  const hkExplain = document.getElementById('hkExplain');
  const closeBtn = document.getElementById('close');
  const tinyClose = document.getElementById('tinyClose');
  // Prompt preset elements (will be injected)
  const hotkeySection = document.getElementById('hotkeyBtns');
  const promptSectionTitle = document.createElement('div'); promptSectionTitle.className='sectionTitle'; promptSectionTitle.textContent='Prompt Presets';
  const promptWrap = document.createElement('div'); promptWrap.style.display='flex'; promptWrap.style.flexDirection='column'; promptWrap.style.gap='12px';
  promptWrap.innerHTML = `
    <label>Summary Preset
      <select id="summaryPreset"></select>
      <small>Template applied when summarizing.</small>
    </label>
    <label>Explanation Preset
      <select id="explainPreset"></select>
      <small>Template applied when explaining.</small>
    </label>
    <label id="customSummaryWrap" style="display:none">Custom Summary Prompt
      <textarea id="customSummary" style="min-height:70px;resize:vertical;background:var(--field);color:var(--fg);border:1px solid var(--field-border);padding:8px 10px;border-radius:8px;font:13px system-ui;font-weight:500"></textarea>
      <small>You can reference the selected text implicitly. Keep concise & instruction-like.</small>
      <button id="saveCustomSummary" style="margin-top:6px;width:120px">Save Custom</button>
    </label>
    <label id="customExplainWrap" style="display:none">Custom Explanation Prompt
      <textarea id="customExplain" style="min-height:70px;resize:vertical;background:var(--field);color:var(--fg);border:1px solid var(--field-border);padding:8px 10px;border-radius:8px;font:13px system-ui;font-weight:500"></textarea>
      <small>Provide instructions for explanation mode. Avoid placeholders; text is provided as user message.</small>
      <button id="saveCustomExplain" style="margin-top:6px;width:120px">Save Custom</button>
    </label>
  `;
  hotkeySection.insertAdjacentElement('afterend', promptSectionTitle);
  promptSectionTitle.insertAdjacentElement('afterend', promptWrap);
  const summaryPresetSel = ()=> document.getElementById('summaryPreset');
  const explainPresetSel = ()=> document.getElementById('explainPreset');
  const customSummaryWrap = ()=> document.getElementById('customSummaryWrap');
  const customExplainWrap = ()=> document.getElementById('customExplainWrap');
  const customSummaryInput = ()=> document.getElementById('customSummary');
  const customExplainInput = ()=> document.getElementById('customExplain');
  const saveCustomSummaryBtn = ()=> document.getElementById('saveCustomSummary');
  const saveCustomExplainBtn = ()=> document.getElementById('saveCustomExplain');
  let recording = null;
  // Convert native key event -> Electron accelerator string
  function formatCombo(e){
    let parts=[]; if(e.metaKey) parts.push('Command'); if(e.ctrlKey) parts.push('Control'); if(e.altKey) parts.push('Alt'); if(e.shiftKey) parts.push('Shift');
    let key=e.key; if(key===' ') key='Space'; if(key==='Escape') key='Esc'; if(key.startsWith('Arrow')) key=key.replace('Arrow',''); if(/^F\d{1,2}$/.test(key)){ } else if(key.length===1){ key=key.toUpperCase(); }
    if(['Control','Shift','Alt','Meta','Command'].includes(key)) return ''; parts.push(key); return parts.join('+');
  }
  // Global key capture while recording a hotkey
  document.addEventListener('keydown', async e=>{
    if(!recording) return; e.preventDefault(); e.stopPropagation();
    const btn = recording==='summary'? hkSumm: hkExplain;
    if(e.key==='Escape'){ btn.textContent= btn.dataset.value || 'Record…'; btn.classList.remove('active'); recording=null; return; }
    if(e.key==='Backspace' || e.key==='Delete'){ btn.dataset.value=''; btn.textContent='Disabled'; btn.classList.remove('active'); recording=null; await saveHotkeys(); return; }
    const combo = formatCombo(e); if(!combo) return; btn.dataset.value=combo; btn.textContent=combo; btn.classList.remove('active'); recording=null; await saveHotkeys();
  });
  hkSumm.onclick = ()=>{ recording='summary'; hkSumm.classList.add('active'); hkSumm.textContent='Press keys…'; };
  hkExplain.onclick = ()=>{ recording='explain'; hkExplain.classList.add('active'); hkExplain.textContent='Press keys…'; };
  async function saveHotkeys(){ await clipAI.setHotkeys(hkSumm.dataset.value||'', hkExplain.dataset.value||''); }
  providerSel.onchange = ()=>{ modelWrap.style.display = ['openai','gemini','anthropic','mistral','groq','cohere'].includes(providerSel.value) ? 'block':'none'; };
  const refreshBtn = ()=> document.getElementById('refreshModels');
  const modelListEl = ()=> document.getElementById('modelList');
  refreshBtn().onclick = async ()=>{
    modelListEl().style.display='block';
    modelListEl().innerHTML='<option disabled>Loading…</option>';
    const {models, error} = await clipAI.listModels(providerSel.value);
    if(error){ modelListEl().innerHTML = `<option disabled>Error: ${error}</option>`; return; }
    if(!models.length){ modelListEl().innerHTML = '<option disabled>No models returned</option>'; return; }
    modelListEl().innerHTML='';
    models.slice(0,200).forEach(m=>{ const opt=document.createElement('option'); opt.value=m; opt.textContent=m; modelListEl().appendChild(opt); });
  };
  modelListEl().addEventListener('change', ()=>{ const sel = modelListEl().value; if(sel){ modelInput.value=sel; } });
  saveKeyBtn.onclick = async ()=>{ const key=keyInput.value.trim(); const model=modelInput.value.trim(); if(!key){ status.textContent='Key empty'; return; } await clipAI.saveProviderKey(providerSel.value,key, model||undefined); await clipAI.setActiveProvider(providerSel.value); keyInput.value=''; modelInput.value=''; status.textContent='Saved'; setTimeout(()=> status.textContent='', 1500); };
  themeSel.onchange = ()=> { ['light','midnight','forest','rose','amber','contrast'].forEach(c=> document.body.classList.remove(c)); if(themeSel.value!=='dark') document.body.classList.add(themeSel.value); clipAI.setTheme(themeSel.value); };
  memorySel.onchange = ()=> clipAI.setMemoryMode(memorySel.value);
  markdownToggle.onchange = ()=> clipAI.setMarkdownEnabled(markdownToggle.checked);
  closeBtn.onclick = ()=> window.close();
  tinyClose.onclick = ()=> window.close();
  (async()=>{ const cfg = await clipAI.getConfig(); providerSel.value = cfg.active; providerSel.onchange(); const c = cfg.providers[cfg.active]||{}; if(c.model) modelInput.value = c.model; ['light','midnight','forest','rose','amber','contrast'].forEach(cn=> document.body.classList.remove(cn)); if(cfg.theme && cfg.theme!=='dark') document.body.classList.add(cfg.theme); themeSel.value = cfg.theme; memorySel.value = cfg.memoryMode || 'normal'; markdownToggle.checked = cfg.markdownEnabled !== false; if(cfg.hotkeys){ if(cfg.hotkeys.summarize){ hkSumm.dataset.value=cfg.hotkeys.summarize; hkSumm.textContent=cfg.hotkeys.summarize; } if(cfg.hotkeys.explain){ hkExplain.dataset.value=cfg.hotkeys.explain; hkExplain.textContent=cfg.hotkeys.explain; } } })();
  // Load prompt presets
  (async()=>{
    const data = await clipAI.getPrompts();
    const {presets, selections} = data;
    const sSel = summaryPresetSel();
    const eSel = explainPresetSel();
  for(const [key,obj] of Object.entries(presets.summary)){
      const opt = document.createElement('option'); opt.value=key; opt.textContent=obj.title; sSel.appendChild(opt);
    }
  { const opt = document.createElement('option'); opt.value='custom'; opt.textContent='Custom…'; sSel.appendChild(opt); }
    for(const [key,obj] of Object.entries(presets.explain)){
      const opt = document.createElement('option'); opt.value=key; opt.textContent=obj.title; eSel.appendChild(opt);
    }
  { const opt = document.createElement('option'); opt.value='custom'; opt.textContent='Custom…'; eSel.appendChild(opt); }
    sSel.value = selections?.summary || 'core_one_liner';
    eSel.value = selections?.explain || 'concise_clarifier';
  function syncCustomVisibility(){ customSummaryWrap().style.display = sSel.value==='custom' ? 'block':'none'; customExplainWrap().style.display = eSel.value==='custom' ? 'block':'none'; }
  syncCustomVisibility();
  if(data.custom){ if(data.custom.summary) customSummaryInput().value = data.custom.summary; if(data.custom.explain) customExplainInput().value = data.custom.explain; }
  sSel.onchange = ()=> { clipAI.setPromptSelection(sSel.value, undefined); syncCustomVisibility(); };
  eSel.onchange = ()=> { clipAI.setPromptSelection(undefined, eSel.value); syncCustomVisibility(); };
  saveCustomSummaryBtn().onclick = async ()=> { await clipAI.setCustomPrompt(customSummaryInput().value, undefined); if(sSel.value!=='custom'){ sSel.value='custom'; sSel.onchange(); } };
  saveCustomExplainBtn().onclick = async ()=> { await clipAI.setCustomPrompt(undefined, customExplainInput().value); if(eSel.value!=='custom'){ eSel.value='custom'; eSel.onchange(); } };
  })();
  clipAI.onThemeChanged?.(t=>{ ['light','midnight','forest','rose','amber','contrast'].forEach(c=> document.body.classList.remove(c)); if(t!=='dark') document.body.classList.add(t); themeSel.value=t; });
</script>
</body></html>
